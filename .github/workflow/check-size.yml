name: 13 KiB Size Check

on:
  pull_request:
    paths:
      - 'submissions/**'
  push:
    branches: [main]
    paths:
      - 'submissions/**'

jobs:
  validate-submission:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•ï¼Œç”¨äºæ¯”è¾ƒå˜åŒ–
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: |
        if [ -f "package.json" ]; then
          npm ci
        fi
    
    - name: Run size check script
      id: size-check
      run: |
        node scripts/check-size.js
        
    - name: Validate submission structure
      id: structure-check
      run: |
        node scripts/validate-structure.js
        
    - name: Check for large files
      id: large-files
      run: |
        find submissions -type f -size +13k | while read file; do
          echo "::error file=${file}::å•ä¸ªæ–‡ä»¶è¶…è¿‡ 13 KiB: ${file}"
        done
        # å¦‚æœæ²¡æœ‰æ‰¾åˆ°å¤§æ–‡ä»¶ï¼Œåˆ›å»ºæˆåŠŸæ ‡å¿—
        if [ $(find submissions -type f -size +13k | wc -l) -eq 0 ]; then
          echo "no-large-files=true" >> $GITHUB_OUTPUT
        else
          echo "no-large-files=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Create detailed report
      if: always()
      run: |
        echo "## ğŸ“Š 13 KiB ä»£ç æ£€æŸ¥æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.size-check.outputs.all-valid }}" = "true" ]; then
          echo "âœ… **æ‰€æœ‰æäº¤çš„ä½œå“éƒ½ç¬¦åˆå¤§å°é™åˆ¶**" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **å‘ç°ä¸ç¬¦åˆå¤§å°é™åˆ¶çš„ä½œå“**" >> $GITHUB_STEP_SUMMARY
          echo "è¯·æ£€æŸ¥ä»¥ä¸‹é¡¹ç›®ï¼š" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.size-check.outputs.invalid-projects }}" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ "${{ steps.large-files.outputs.no-large-files }}" = "true" ]; then
          echo "âœ… **æ²¡æœ‰å•ä¸ªæ–‡ä»¶è¶…è¿‡ 13 KiB**" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ **æ³¨æ„ï¼šæœ‰å•ä¸ªæ–‡ä»¶è¶…è¿‡ 13 KiB**" >> $GITHUB_STEP_SUMMARY
          echo "å»ºè®®å°†å¤§æ–‡ä»¶åˆ†å‰²æˆ–å‹ç¼©" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“ˆ å¤§å°ç»Ÿè®¡" >> $GITHUB_STEP_SUMMARY
        echo "${{ steps.size-check.outputs.size-table }}" >> $GITHUB_STEP_SUMMARY
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "*æ£€æŸ¥æ—¶é—´: $(date)*" >> $GITHUB_STEP_SUMMARY
        
    - name: Comment on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const summary = fs.readFileSync(process.env.GITHUB_STEP_SUMMARY, 'utf8');
          
          // ä» summary ä¸­æå– Markdown éƒ¨åˆ†
          const prComment = `## ğŸ¤– 13 KiB ä»£ç æ£€æŸ¥ç»“æœ
          
${summary.split('## ğŸ“Š')[1] || summary}

*æ¥è‡ª GitHub Actions æœºå™¨äºº*`;
          
          await github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: prComment
          });
